{% extends "templates/layout.html" %} {% block title %}Dashboard - Broto Fácil{%
endblock %} {% block content %}

<nav class="navbar navbar-expand-lg bg-white position-fixed w-100 mb-4" style="z-index: 99999;">
  <div class="container">
    <div style="gap: 12px;" class="d-flex gap-3 align-items-center">
      <div class="rounded-circle bg-primary-c d-flex justify-content-center align-items-center"
        style="height: 40px;width: 40px;">
        <i class="fa-solid fa-user opacity-100 text-white"></i>
      </div>
      <div class="d-flex flex-column">
        <span class="opacity-75 text-gray">
          Seja bem vindo!
        </span>
        <span class="fw-bold text-secondary-c">
          {{ user.username }}
        </span>
      </div>
    </div>
    <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-second p-2 rounded-circle position-relative" style="height: 56px;width:56px"
      type="button">
      <i class="fa-solid fa-xl fa-arrows-rotate absolute-center"></i>
    </a>
</nav>


<div class="container pt-5 mt-5">
  <!-- <a class="text-start" href="{{ url_for('home.index') }}">
    <button class="btn btn-second">
      <i class="fa-solid fa-angles-left"></i> LOGOUT
    </button>
  </a> -->

  <div class="d-flex justify-content-start align-items-center gap-2 mt-3 mb-3">
    <a href="{{ url_for('api.exportar_csv') }}" class="btn btn-second-gray"
      ><i class="fa-solid fa-file-arrow-down fa-lg me-1"></i> CSV</a
    >

    <div class="dropdown">
      <button
        class="btn btn-second-gray dropdown-toggle"
        type="button"
        id="filterButton"
        data-bs-toggle="dropdown"
        aria-expanded="false"
      >
        Período
      </button>
      <ul class="dropdown-menu" aria-labelledby="filterButton">
        <li>
          <a
            class="dropdown-item"
            href="{{ url_for('dashboard.dashboard', filtro='1hora') }}"
            >Última 1 hora</a
          >
        </li>
        <li>
          <a
            class="dropdown-item"
            href="{{ url_for('dashboard.dashboard', filtro='1dia') }}"
            >Último 1 dia</a
          >
        </li>
        <li>
          <a
            class="dropdown-item"
            href="{{ url_for('dashboard.dashboard', filtro='7dias') }}"
            >Últimos 7 dias</a
          >
        </li>
        <li>
          <a
            class="dropdown-item"
            href="{{ url_for('dashboard.dashboard', filtro='1mes') }}"
            >Último 1 mês</a
          >
        </li>
      </ul>
    </div>
  </div>

  <h1 class="title text-center">Dashboard</h1>

  <!-- Gráficos Resumo -->
  <div class="row">
    <div class="col-6 col-md-4 col-lg-3">
      <span class="fw-semibold">Temperatura (°C)</span>
      <canvas id="chartTempResumo" class="chart"></canvas>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <span class="fw-semibold">Umidade (%)</span>
      <canvas id="chartUmidadeResumo" class="chart"></canvas>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <span class="fw-semibold">Luminosidade (%)</span>
      <canvas id="chartLumResumo" class="chart"></canvas>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <span class="fw-semibold">Umidade do Solo (%)</span>
      <canvas id="chartUmidadeSoloResumo" class="chart"></canvas>
    </div>
  </div>

  <div class="accordion mt-5 border-0 shadow-sm" id="accordionExample">
    <div class="accordion-item border-0">
      <h2 class="accordion-header">
        <button
          class="accordion-button"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#collapseOne"
          aria-expanded="false"
          aria-controls="collapseOne"
        >
          <h3>Temperatura (°C)</h3>
        </button>
      </h2>
      <div
        id="collapseOne"
        class="accordion-collapse collapse show"
        data-bs-parent="#accordionExample"
      >
        <div class="accordion-body">
          <!-- Gráfico de Temperatura -->
          <div class="row mt-3">
            <div class="col">
              <canvas id="chartTemperatura" class="chart-big"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="accordion-item border-0">
      <h2 class="accordion-header">
        <button
          class="accordion-button collapsed"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#collapseTwo"
          aria-expanded="false"
          aria-controls="collapseTwo"
        >
          <h3>Umidade (%)</h3>
        </button>
      </h2>
      <div
        id="collapseTwo"
        class="accordion-collapse collapse"
        data-bs-parent="#accordionExample"
      >
        <div class="accordion-body">
          <!-- Gráfico de Umidade -->
          <div class="row mt-3">
            <div class="col">
              <canvas id="chartUmidade" class="chart-big"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="accordion-item border-0">
      <h2 class="accordion-header">
        <button
          class="accordion-button collapsed"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#collapseThree"
          aria-expanded="false"
          aria-controls="collapseThree"
        >
          <h3>Luminosidade (%)</h3>
        </button>
      </h2>
      <div
        id="collapseThree"
        class="accordion-collapse collapse"
        data-bs-parent="#accordionExample"
      >
        <div class="accordion-body">
          <!-- Gráfico de Luminosidade -->
          <div class="row mt-3">
            <div class="col">
              <canvas id="chartLuminosidade" class="chart-big"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="accordion-item border-0">
      <h2 class="accordion-header">
        <button
          class="accordion-button collapsed"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#collapseFour"
          aria-expanded="false"
          aria-controls="collapseFour"
        >
          <h3>Umidade do Solo (%)</h3>
        </button>
      </h2>
      <div
        id="collapseFour"
        class="accordion-collapse collapse"
        data-bs-parent="#accordionExample"
      >
        <div class="accordion-body">
          <!-- Gráfico de Umidade do Solo -->
          <div class="row mt-3">
            <div class="col">
              <canvas id="chartUmidadeSolo" class="chart-big"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<nav class="nav-bottom">
  <a href="{{ url_for('home.index') }}" class="btn">
    <i class="fa-solid fa-house"></i>
  </a>
  <a href="{{ url_for('dashboard.dashboard') }}" class="btn">
    <i class="fa-solid fa-chart-pie"></i>
  </a>
  <a href="{{ url_for('auth.login') }}" class="btn">
    <i class="fa-solid fa-user"></i>
  </a>
</nav>

<!-- Estilos CSS -->
<script>
  // Captura o evento de clique no dropdown e redireciona para a rota com o filtro correto
  document.querySelectorAll(".dropdown-item").forEach((item) => {
    item.addEventListener("click", function () {
      const filterDays = this.getAttribute("data-filter"); // Obtém o valor de filtro (1, 7 ou 30)
      window.location.href = `/dashboard?days=${filterDays}`;
    });
  });
</script>

<!-- Biblioteca Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Script de configuração dos gráficos -->
<script>
  // Dados vindos do backend
  const dataFromBackend = {
    timestamps: {{ timestamps | tojson | safe }},
    temperaturas: {{ temperaturas | tojson | safe }},
    umidades: {{ umidades | tojson | safe }},
    luminosidades: {{ luminosidades | tojson | safe }},
    umidadesolos: {{ umidadesolos | tojson | safe }}
  };

  // Obter o último valor de cada conjunto de dados
  const ultimaTemperatura = dataFromBackend.temperaturas[dataFromBackend.temperaturas.length - 1];
  const ultimaUmidade = dataFromBackend.umidades[dataFromBackend.umidades.length - 1];
  const ultimaLuminosidade = dataFromBackend.luminosidades[dataFromBackend.luminosidades.length - 1];
  const ultimaUmidadeSolo = dataFromBackend.umidadesolos[dataFromBackend.umidadesolos.length - 1];

  // Plugin para desenhar texto no centro do gráfico
  const centerTextPlugin = {
    id: 'centerText',
    afterDraw(chart) {
      const ctx = chart.ctx;
      const data = chart.data.datasets[0].data;
      const total = data.reduce((acc, val) => acc + val, 0);
      const centerValue = Math.round(data[0]); // Apenas o valor do gráfico

      ctx.save();
      ctx.font = 'bold 14px Arial';
      ctx.fillStyle = 'black'; // Cor do texto
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(centerValue, chart.width / 2, chart.height / 2);
      ctx.restore();
    }
  };

  // Gráfico Circular de Temperatura
  const ctxTempResumo = document.getElementById('chartTempResumo').getContext('2d');
  new Chart(ctxTempResumo, {
    type: 'doughnut',
    data: {
      labels: ['Temperatura'],
      datasets: [{
        data: [ultimaTemperatura, 100 - ultimaTemperatura],
        backgroundColor: ['rgba(102, 164, 4, 1)', 'rgba(200, 200, 200, 0.3)'],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        centerText: true // Adiciona o plugin
      }
    },
    plugins: [centerTextPlugin] // Registra o plugin
  });

  // Gráfico Circular de Umidade
  const ctxUmidadeResumo = document.getElementById('chartUmidadeResumo').getContext('2d');
  new Chart(ctxUmidadeResumo, {
    type: 'doughnut',
    data: {
      labels: ['Umidade'],
      datasets: [{
        data: [ultimaUmidade, 100 - ultimaUmidade],
        backgroundColor: ['rgba(255, 215, 89, 1)', 'rgba(200, 200, 200, 0.3)'],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        centerText: true // Adiciona o plugin
      }
    },
    plugins: [centerTextPlugin] // Registra o plugin
  });

  // Gráfico Circular de Luminosidade
  const ctxLumResumo = document.getElementById('chartLumResumo').getContext('2d');
  new Chart(ctxLumResumo, {
    type: 'doughnut',
    data: {
      labels: ['Luminosidade'],
      datasets: [{
        data: [ultimaLuminosidade, 100 - ultimaLuminosidade],
        backgroundColor: ['rgba(255, 87, 51, 1)', 'rgba(200, 200, 200, 0.3)'],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        centerText: true // Adiciona o plugin
      }
    },
    plugins: [centerTextPlugin] // Registra o plugin
  });

  // Gráfico Circular de Umidade do Solo
  const ctxUmidadeSoloResumo = document.getElementById('chartUmidadeSoloResumo').getContext('2d');
  new Chart(ctxUmidadeSoloResumo, {
    type: 'doughnut',
    data: {
      labels: ['Umidade do Solo'],
      datasets: [{
        data: [ultimaUmidadeSolo, 100 - ultimaUmidadeSolo],
        backgroundColor: ['rgba(3, 38, 3, 1)', 'rgba(200, 200, 200, 0.3)'],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        centerText: true // Adiciona o plugin
      }
    },
    plugins: [centerTextPlugin] // Registra o plugin
  });

  // Gráfico de Temperatura
  const ctxTemp = document.getElementById('chartTemperatura').getContext('2d');
  new Chart(ctxTemp, {
    type: 'line',
    data: {
      labels: dataFromBackend.timestamps,
      datasets: [{
        label: 'Temperatura (°C)',
        data: dataFromBackend.temperaturas,
        borderColor: 'rgba(102, 164, 4, 1)',
        backgroundColor: 'rgba(102, 164, 4, 0.5)',
        fill: false,
        tension: 0.4
      }]
    }
  });

  // Gráfico de Umidade
  const ctxUmidade = document.getElementById('chartUmidade').getContext('2d');
  new Chart(ctxUmidade, {
    type: 'bar',
    data: {
      labels: dataFromBackend.timestamps,
      datasets: [{
        label: 'Umidade (%)',
        data: dataFromBackend.umidades,
        borderColor: 'rgba(255, 215, 89, 1)',
        backgroundColor: 'rgba(255, 215, 89, 0.5)'
      }]
    }
  });

  // Gráfico de Luminosidade
  const ctxLum = document.getElementById('chartLuminosidade').getContext('2d');
  new Chart(ctxLum, {
    type: 'bar',
    data: {
      labels: dataFromBackend.timestamps,
      datasets: [{
        label: 'Luminosidade (%)',
        data: dataFromBackend.luminosidades,
        borderColor: 'rgba(255, 87, 51, 1)',
        backgroundColor: 'rgba(255, 87, 51, 0.5)'
      }]
    }
  });

  // Gráfico de Umidade do Solo
  const ctxUmidadeSolo = document.getElementById('chartUmidadeSolo').getContext('2d');
  new Chart(ctxUmidadeSolo, {
    type: 'bar',
    data: {
      labels: dataFromBackend.timestamps,
      datasets: [{
        label: 'Umidade do Solo (%)',
        data: dataFromBackend.umidadesolos,
        borderColor: 'rgba(3, 38, 3, 1)',
        backgroundColor: 'rgba(3, 38, 3, 0.5)'
      }]
    }
  });
</script>

{% endblock %}
