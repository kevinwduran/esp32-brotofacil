{% extends "templates/layout.html" %} {% block title %}Dashboard - Broto Fácil{%
endblock %} {% block content %}
<div class="container-sm">

  <h1 class="title">Dashboard</h1>
  
  <div class="d-flex gap-2 justify-content-center my-3 py-2 bg-white rounded-4">
    <a href="{{ url_for('api.exportar_csv') }}" style="min-width: 150px;" class="btn btn-custom"><i class="fa-solid fa-file-arrow-down me-2"></i>
      CSV</a>

    <div class="dropdown">
      <button class="btn btn-custom dropdown-toggle" type="button" style="min-width: 150px;" id="filterButton" data-bs-toggle="dropdown"
        aria-expanded="false">
        Filtrar
      </button>
      <ul class="dropdown-menu" aria-labelledby="filterButton">
        <li><a class="dropdown-item" href="{{ url_for('dashboard.dashboard', filtro='1hora') }}">Última 1 hora</a></li>
        <li><a class="dropdown-item" href="{{ url_for('dashboard.dashboard', filtro='1dia') }}">Último 1 dia</a></li>
        <li><a class="dropdown-item" href="{{ url_for('dashboard.dashboard', filtro='7dias') }}">Últimos 7 dias</a></li>
        <li><a class="dropdown-item" href="{{ url_for('dashboard.dashboard', filtro='1mes') }}">Último 1 mês</a></li>
      </ul>
    </div>
  </div>

  <!-- Gráficos Resumo -->
  <div class="row">
    <div class="col-6 col-md-4 col-lg-3 mt-3">
      <div class="bg-white rounded-5 p-3 text-center h-100">
      <span class="fw-semibold">Temperatura (°C)</span>
      <canvas id="chartTempResumo" class="chart"></canvas>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-3 mt-3">
      <div class="bg-white rounded-5 p-3 text-center h-100">
      <span class="fw-semibold">Umidade (%)</span>
      <canvas id="chartUmidadeResumo" class="chart"></canvas>
    </div>
    </div>
    <div class="col-6 col-md-4 col-lg-3 mt-3">
      <div class="bg-white rounded-5 p-3 text-center h-100">
      <span class="fw-semibold">Luminosidade (%)</span>
      <canvas id="chartLumResumo" class="chart"></canvas>
    </div>
    </div>
    <div class="col-6 col-md-4 col-lg-3 mt-3">
      <div class="bg-white rounded-5 p-3 text-center h-100">
      <span class="fw-semibold">Umidade do Solo (%)</span>
      <canvas id="chartUmidadeSoloResumo" class="chart"></canvas>
    </div>
    </div>
  </div>

  <div class="mt-5 w-100">
  <span>Dados do filtro</span>
  <div class="d-flex gap-2 container-button-data-filter">
    
    <div class="container-button" >
    <button onclick="openContainerData('container-temperatura')" class="btn rounded-4 d-flex flex-column gap-3 align-items-center justify-content-center">
      <img src="{{ url_for('static', filename='icons/thermometer_1f321-fe0f.png') }}" class="w-100" style="object-fit:contain!important" />
      <span class="font-12px">Temp.</span>
    </button>
  </div>

  <div class="container-button" >
    <button onclick="openContainerData('container-umidade')" class="btn rounded-4 d-flex flex-column gap-3 align-items-center justify-content-center">
      <img src="{{ url_for('static', filename='icons/sweat-droplets_1f4a6.png') }}" class="w-100" style="object-fit:contain!important" />
      <span class="font-12px">Umid.</span>
    </button>
  </div>

    <div class="container-button" >
    <button onclick="openContainerData('container-luminosidade')" class="btn rounded-4 d-flex flex-column gap-3 align-items-center justify-content-center">
      <img src="{{ url_for('static', filename='icons/sun_2600-fe0f.png') }}" class="w-100" style="object-fit:contain!important" />
      <span class="font-12px">Lumi.</span>
    </button>
  </div>

    <div class="container-button" >
    <button onclick="openContainerData('container-umidade-solo')" class="btn rounded-4 d-flex flex-column gap-3 align-items-center justify-content-center">
      <img src="{{ url_for('static', filename='icons/herb_1f33f.png') }}"class="w-100" style="object-fit:contain!important" />
      <span class="font-12px">Umi. Solo</span>
    </button>
  </div>

  </div>
</div>

<div class="bg-white rounded-5 py-3 px-2 px-md-3 mt-2">
<div class="row mt-3 container-temperatura">
  <div class="col">
    <h3>Temperatura (°C)</h3>
    <canvas id="chartTemperatura" class="chart-big"></canvas>
  </div>
</div>

<div class="row mt-3 container-umidade d-none">
  <div class="col">
    <h3>Umidade (%)</h3>
    <canvas id="chartUmidade" class="chart-big"></canvas>
  </div>
</div>

<div class="row mt-3 container-luminosidade d-none">
  <div class="col">
    <h3>Luminosidade (%)</h3>
    <canvas id="chartLuminosidade" class="chart-big"></canvas>
  </div>
</div>

<div class="row mt-3 container-umidade-solo d-none">
  <div class="col">
    <h3>Umidade do Solo (%)</h3>
    <canvas id="chartUmidadeSolo" class="chart-big"></canvas>
  </div>
</div>
</div>


<script>
  let containerTemperatura = document.querySelector('.container-temperatura');
  let containerUmidade = document.querySelector('.container-umidade');
  let containerLuminosidade = document.querySelector('.container-luminosidade');
  let containerUmidadeSolo = document.querySelector('.container-umidade-solo');

  function openContainerData(container){
    closeContainersData();
    console.log(container)
    document.querySelector(`.${container}`).classList.remove('d-none');
  }

  function closeContainersData(){
    containerTemperatura.classList.add('d-none');
    containerUmidade.classList.add('d-none');
    containerLuminosidade.classList.add('d-none');
    containerUmidadeSolo.classList.add('d-none');
  }
</script>


<!-- Estilos CSS -->
<script>
  // Captura o evento de clique no dropdown e redireciona para a rota com o filtro correto
  document.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', function() {
      const filterDays = this.getAttribute('data-filter'); // Obtém o valor de filtro (1, 7 ou 30)
      window.location.href = `/dashboard?days=${filterDays}`;
    });
  });
</script>

<!-- Biblioteca Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Script de configuração dos gráficos -->
<script>
  // Dados vindos do backend
  const dataFromBackend = {
    timestamps: {{ timestamps | tojson | safe }},
    temperaturas: {{ temperaturas | tojson | safe }},
    umidades: {{ umidades | tojson | safe }},
    luminosidades: {{ luminosidades | tojson | safe }},
    umidadesolos: {{ umidadesolos | tojson | safe }}
  };

  // Obter o último valor de cada conjunto de dados
  const ultimaTemperatura = dataFromBackend.temperaturas[dataFromBackend.temperaturas.length - 1];
  const ultimaUmidade = dataFromBackend.umidades[dataFromBackend.umidades.length - 1];
  const ultimaLuminosidade = dataFromBackend.luminosidades[dataFromBackend.luminosidades.length - 1];
  const ultimaUmidadeSolo = dataFromBackend.umidadesolos[dataFromBackend.umidadesolos.length - 1];

  // Plugin para desenhar texto no centro do gráfico
  const centerTextPlugin = {
    id: 'centerText',
    afterDraw(chart) {
      const ctx = chart.ctx;
      const data = chart.data.datasets[0].data;
      const total = data.reduce((acc, val) => acc + val, 0);
      const centerValue = Math.round(data[0]); // Apenas o valor do gráfico

      ctx.save();
      ctx.font = 'bold 14px Arial';
      ctx.fillStyle = 'black'; // Cor do texto
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(centerValue, chart.width / 2, chart.height / 2);
      ctx.restore();
    }
  };

  // Gráfico Circular de Temperatura
  const ctxTempResumo = document.getElementById('chartTempResumo').getContext('2d');
  new Chart(ctxTempResumo, {
    type: 'doughnut',
    data: {
      labels: ['Temperatura'],
      datasets: [{
        data: [ultimaTemperatura, 100 - ultimaTemperatura],
        backgroundColor: ['rgba(102, 164, 4, 1)', 'rgba(200, 200, 200, 0.3)'],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        centerText: true // Adiciona o plugin
      }
    },
    plugins: [centerTextPlugin] // Registra o plugin
  });

  // Gráfico Circular de Umidade
  const ctxUmidadeResumo = document.getElementById('chartUmidadeResumo').getContext('2d');
  new Chart(ctxUmidadeResumo, {
    type: 'doughnut',
    data: {
      labels: ['Umidade'],
      datasets: [{
        data: [ultimaUmidade, 100 - ultimaUmidade],
        backgroundColor: ['rgba(255, 215, 89, 1)', 'rgba(200, 200, 200, 0.3)'],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        centerText: true // Adiciona o plugin
      }
    },
    plugins: [centerTextPlugin] // Registra o plugin
  });

  // Gráfico Circular de Luminosidade
  const ctxLumResumo = document.getElementById('chartLumResumo').getContext('2d');
  new Chart(ctxLumResumo, {
    type: 'doughnut',
    data: {
      labels: ['Luminosidade'],
      datasets: [{
        data: [ultimaLuminosidade, 100 - ultimaLuminosidade],
        backgroundColor: ['rgba(255, 87, 51, 1)', 'rgba(200, 200, 200, 0.3)'],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        centerText: true // Adiciona o plugin
      }
    },
    plugins: [centerTextPlugin] // Registra o plugin
  });

  // Gráfico Circular de Umidade do Solo
  const ctxUmidadeSoloResumo = document.getElementById('chartUmidadeSoloResumo').getContext('2d');
  new Chart(ctxUmidadeSoloResumo, {
    type: 'doughnut',
    data: {
      labels: ['Umidade do Solo'],
      datasets: [{
        data: [ultimaUmidadeSolo, 100 - ultimaUmidadeSolo],
        backgroundColor: ['rgba(3, 38, 3, 1)', 'rgba(200, 200, 200, 0.3)'],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        centerText: true // Adiciona o plugin
      }
    },
    plugins: [centerTextPlugin] // Registra o plugin
  });

  // Gráfico de Temperatura
  const ctxTemp = document.getElementById('chartTemperatura').getContext('2d');
  new Chart(ctxTemp, {
    type: 'line',
    data: {
      labels: dataFromBackend.timestamps,
      datasets: [{
        label: 'Temperatura (°C)',
        data: dataFromBackend.temperaturas,
        borderColor: 'rgba(102, 164, 4, 1)',
        backgroundColor: 'rgba(102, 164, 4, 0.5)',
        fill: false,
        tension: 0.4
      }]
    }
  });

  // Gráfico de Umidade
  const ctxUmidade = document.getElementById('chartUmidade').getContext('2d');
  new Chart(ctxUmidade, {
    type: 'bar',
    data: {
      labels: dataFromBackend.timestamps,
      datasets: [{
        label: 'Umidade (%)',
        data: dataFromBackend.umidades,
        borderColor: 'rgba(255, 215, 89, 1)',
        backgroundColor: 'rgba(255, 215, 89, 0.5)'
      }]
    }
  });

  // Gráfico de Luminosidade
  const ctxLum = document.getElementById('chartLuminosidade').getContext('2d');
  new Chart(ctxLum, {
    type: 'bar',
    data: {
      labels: dataFromBackend.timestamps,
      datasets: [{
        label: 'Luminosidade (%)',
        data: dataFromBackend.luminosidades,
        borderColor: 'rgba(255, 87, 51, 1)',
        backgroundColor: 'rgba(255, 87, 51, 0.5)'
      }]
    }
  });

  // Gráfico de Umidade do Solo
  const ctxUmidadeSolo = document.getElementById('chartUmidadeSolo').getContext('2d');
  new Chart(ctxUmidadeSolo, {
    type: 'bar',
    data: {
      labels: dataFromBackend.timestamps,
      datasets: [{
        label: 'Umidade do Solo (%)',
        data: dataFromBackend.umidadesolos,
        borderColor: 'rgba(3, 38, 3, 1)',
        backgroundColor: 'rgba(3, 38, 3, 0.5)'
      }]
    }
  });
</script>

{% endblock %}